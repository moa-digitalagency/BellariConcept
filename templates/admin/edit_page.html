{% extends "admin/base.html" %}

{% block title %}{% if lang == 'fr' %}Modifier{% else %}Edit{% endif %} {{ page.title }}{% endblock %}
{% block page_title %}{% if lang == 'fr' %}Modifier{% else %}Edit{% endif %}: {{ page.title }}{% endblock %}

{% block content %}
<style>
.image-preview {
    max-width: 200px;
    max-height: 150px;
    border-radius: 8px;
}
.resolution-badge {
    background: #10b981;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
}
.lang-column {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
}
.lang-column.fr {
    border-color: #3b82f6;
    background: #eff6ff;
}
.lang-column.en {
    border-color: #10b981;
    background: #f0fdf4;
}
</style>

<div class="mb-6">
    <a href="/admin/pages" class="text-accent hover:text-primary font-semibold">‚Üê {% if lang == 'fr' %}Retour aux pages{% else %}Back to Pages{% endif %}</a>
</div>

<div class="bg-white rounded-lg shadow p-6 mb-8">
    <h3 class="text-xl font-bold text-primary mb-6">{% if lang == 'fr' %}Param√®tres de la Page & SEO{% else %}Page Settings & SEO{% endif %}</h3>
    <form method="POST" action="/admin/page/{{ page.id }}/update" class="space-y-4">
        <input type="hidden" name="lang" value="{{ lang }}">
        <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
                {% if lang == 'fr' %}Titre de la page{% else %}Page Title{% endif %}
            </label>
            <input type="text" name="title" value="{{ page.title }}" required 
                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-accent focus:outline-none">
        </div>
        
        <div>
            <label class="block text-sm font-semibold text-gray-700 mb-2">
                Meta Description (SEO)
                <span class="text-xs text-gray-500 ml-2">{% if lang == 'fr' %}Recommand√©: 150-160 caract√®res{% else %}Recommended: 150-160 characters{% endif %}</span>
            </label>
            <textarea name="meta_description" rows="2" maxlength="160"
                      class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:border-accent focus:outline-none">{{ page.meta_description }}</textarea>
            <p class="text-xs text-gray-500 mt-1">
                {% if lang == 'fr' %}Cette description appara√Æt dans les r√©sultats de recherche Google{% else %}This description appears in Google search results{% endif %}
            </p>
        </div>
        
        <div class="flex items-center">
            <input type="checkbox" name="is_active" id="page_active" {{ 'checked' if page.is_active }} 
                   class="w-4 h-4 text-accent border-gray-300 rounded focus:ring-accent">
            <label for="page_active" class="ml-2 text-sm font-semibold text-gray-700">
                {% if lang == 'fr' %}Page active{% else %}Page Active{% endif %}
            </label>
        </div>
        
        <button type="submit" class="bg-accent text-white px-6 py-3 rounded-full hover:bg-primary transition-colors font-semibold">
            {% if lang == 'fr' %}Mettre √† jour{% else %}Update Page Settings{% endif %}
        </button>
    </form>
</div>

<div class="bg-white rounded-lg shadow p-6 mb-8">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-primary">
            {% if lang == 'fr' %}Sections de la page (FR & EN){% else %}Page Sections (FR & EN){% endif %}
        </h3>
        <button onclick="showAddSection()" class="bg-accent text-white px-4 py-2 rounded-full hover:bg-primary transition-colors text-sm font-semibold">
            + {% if lang == 'fr' %}Ajouter une section{% else %}Add Section{% endif %}
        </button>
    </div>
    
    <div id="addSectionForm" class="hidden mb-6 p-6 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg border-2 border-blue-200">
        <h4 class="font-bold text-lg mb-4 text-blue-900">{% if lang == 'fr' %}Nouvelle section (cr√©er FR et EN){% else %}New Section (create FR and EN){% endif %}</h4>
        <p class="text-sm text-blue-700 mb-4">{% if lang == 'fr' %}Cette action cr√©era deux sections: une en fran√ßais et une en anglais{% else %}This will create two sections: one in French and one in English{% endif %}</p>
        <form method="POST" action="/admin/section/create_both" class="space-y-4">
            <input type="hidden" name="page_id" value="{{ page.id }}">
            <input type="hidden" name="lang" value="{{ lang }}">
            
            <div>
                <label class="block text-sm font-semibold text-gray-700 mb-2">
                    {% if lang == 'fr' %}Type de section{% else %}Section Type{% endif %}
                </label>
                <select name="section_type" class="w-full px-4 py-2 border border-gray-300 rounded-lg text-sm focus:border-accent focus:outline-none">
                    <option value="text">Text</option>
                    <option value="hero">Hero</option>
                    <option value="service">Service</option>
                    <option value="contact">Contact</option>
                    <option value="features">Features</option>
                </select>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="lang-column fr">
                    <h5 class="font-bold text-blue-700 mb-3">üá´üá∑ Fran√ßais</h5>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">Titre</label>
                            <input type="text" name="heading_fr" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:border-accent focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">Sous-titre</label>
                            <input type="text" name="subheading_fr" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:border-accent focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">Contenu</label>
                            <textarea name="content_fr" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:border-accent focus:outline-none"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="lang-column en">
                    <h5 class="font-bold text-green-700 mb-3">üá¨üáß English</h5>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">Heading</label>
                            <input type="text" name="heading_en" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:border-accent focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">Subheading</label>
                            <input type="text" name="subheading_en" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:border-accent focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">Content</label>
                            <textarea name="content_en" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:border-accent focus:outline-none"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button type="submit" class="bg-accent text-white px-6 py-3 rounded-full hover:bg-primary transition-colors text-sm font-semibold">
                    {% if lang == 'fr' %}Cr√©er les sections{% else %}Create Sections{% endif %}
                </button>
                <button type="button" onclick="hideAddSection()" class="bg-gray-300 text-gray-700 px-6 py-3 rounded-full hover:bg-gray-400 transition-colors text-sm font-semibold">
                    {% if lang == 'fr' %}Annuler{% else %}Cancel{% endif %}
                </button>
            </div>
        </form>
    </div>
    
    <div class="space-y-8">
        {% for (order_idx, section_type), sections_dict in section_groups %}
        <div class="border-2 border-purple-200 bg-purple-50/30 rounded-xl p-6">
            <div class="flex justify-between items-start mb-6">
                <div class="flex gap-2">
                    <span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white px-4 py-2 rounded-full text-sm font-bold uppercase">{{ section_type }}</span>
                    <span class="bg-gray-600 text-white px-4 py-2 rounded-full text-sm font-bold">{% if lang == 'fr' %}Position{% else %}Order{% endif %} {{ order_idx }}</span>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {% for lang_code in ['fr', 'en'] %}
                {% set section = sections_dict[lang_code] %}
                <div class="lang-column {{ lang_code }}">
                    <div class="flex justify-between items-center mb-4">
                        <h5 class="font-bold text-lg">
                            {% if lang_code == 'fr' %}üá´üá∑ Fran√ßais{% else %}üá¨üáß English{% endif %}
                        </h5>
                        {% if section %}
                        <span class="px-3 py-1 rounded-full text-xs font-bold {{ 'bg-green-500 text-white' if section.is_active else 'bg-gray-400 text-white' }}">
                            {{ '‚úì Active' if section.is_active else '‚úó Inactive' }}
                        </span>
                        {% else %}
                        <span class="px-3 py-1 rounded-full text-xs font-bold bg-red-500 text-white">
                            {% if lang == 'fr' %}Non cr√©√©e{% else %}Not created{% endif %}
                        </span>
                        {% endif %}
                    </div>
                    
                    {% if section %}
                    <form method="POST" action="/admin/section/{{ section.id }}/update" class="space-y-3">
                        <input type="hidden" name="lang" value="{{ lang }}">
                        
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                {% if lang == 'fr' %}Titre principal{% else %}Heading{% endif %}
                            </label>
                            <input type="text" name="heading" value="{{ section.heading or '' }}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:border-accent focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                {% if lang == 'fr' %}Sous-titre{% else %}Subheading{% endif %}
                            </label>
                            <input type="text" name="subheading" value="{{ section.subheading or '' }}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:border-accent focus:outline-none">
                        </div>
                        
                        <div>
                            <label class="block text-xs font-semibold text-gray-700 mb-1">
                                {% if lang == 'fr' %}Contenu{% else %}Content{% endif %}
                            </label>
                            <textarea name="content" rows="4" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:border-accent focus:outline-none">{{ section.content or '' }}</textarea>
                        </div>
                        
                        <div class="flex items-center justify-between pt-3 border-t">
                            <div class="flex items-center">
                                <input type="checkbox" name="is_active" id="section_{{ section.id }}_active" {{ 'checked' if section.is_active }} 
                                       class="w-4 h-4 text-accent border-gray-300 rounded">
                                <label for="section_{{ section.id }}_active" class="ml-2 text-xs font-semibold text-gray-700">
                                    Active
                                </label>
                            </div>
                            
                            <div class="flex gap-2">
                                <button type="submit" class="bg-accent text-white px-4 py-2 rounded-full hover:bg-primary transition-colors text-xs font-semibold">
                                    üíæ {% if lang == 'fr' %}Sauvegarder{% else %}Save{% endif %}
                                </button>
                                <button type="button" onclick="if(confirm('{% if lang == 'fr' %}Supprimer cette section ?{% else %}Delete this section?{% endif %}')) { document.getElementById('delete_form_{{ section.id }}').submit(); }" 
                                        class="text-red-600 hover:text-red-800 text-xs font-semibold px-3 py-2">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </form>
                    <form id="delete_form_{{ section.id }}" method="POST" action="/admin/section/{{ section.id }}/delete" class="hidden">
                        <input type="hidden" name="lang" value="{{ lang }}">
                    </form>
                    {% else %}
                    <div class="text-center py-8 text-gray-500">
                        <p class="mb-4">{% if lang == 'fr' %}Section non cr√©√©e pour cette langue{% else %}Section not created for this language{% endif %}</p>
                        <form method="POST" action="/admin/section/create" class="space-y-3">
                            <input type="hidden" name="page_id" value="{{ page.id }}">
                            <input type="hidden" name="lang" value="{{ lang }}">
                            <input type="hidden" name="section_type" value="{{ section_type }}">
                            <input type="hidden" name="language_code" value="{{ lang_code }}">
                            <input type="hidden" name="order_index" value="{{ order_idx }}">
                            <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-full hover:bg-blue-600 transition-colors text-xs font-semibold">
                                + {% if lang == 'fr' %}Cr√©er cette version{% else %}Create this version{% endif %}
                            </button>
                        </form>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="mt-8 bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-300 rounded-lg p-6">
    <h3 class="text-lg font-bold text-blue-900 mb-4">üìö {% if lang == 'fr' %}Guide d'utilisation{% else %}Usage Guide{% endif %}</h3>
    <div class="text-sm text-blue-800 space-y-3">
        <div class="bg-white rounded-lg p-3">
            <p class="font-bold mb-1">{% if lang == 'fr' %}üåç √âdition bilingue{% else %}üåç Bilingual Editing{% endif %}:</p>
            <p>{% if lang == 'fr' %}Vous pouvez maintenant modifier les sections FR et EN c√¥te √† c√¥te. Chaque section peut √™tre activ√©e/d√©sactiv√©e ind√©pendamment.{% else %}You can now edit FR and EN sections side by side. Each section can be enabled/disabled independently.{% endif %}</p>
        </div>
        
        <div class="bg-white rounded-lg p-3">
            <p class="font-bold mb-1">{% if lang == 'fr' %}üìÅ Images disponibles{% else %}üìÅ Available Images{% endif %}:</p>
            <ul class="list-disc list-inside ml-4 mt-2 space-y-1 text-xs">
                <li>/static/images/modern_construction__a427a1cf.jpg</li>
                <li>/static/images/professional_electri_984ae0e8.jpg</li>
                <li>/static/images/plumber_fixing_pipes_d4c8be18.jpg</li>
                <li>/static/images/painter_painting_wal_be02294b.jpg</li>
                <li>/static/images/hvac_air_conditionin_8336dff9.jpg</li>
                <li>/static/images/swimming_pool_mainte_0698f0ec.jpg</li>
            </ul>
        </div>
    </div>
</div>

<div id="imagePickerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="closeImagePicker(event)">
    <div class="bg-white rounded-lg max-w-5xl w-full max-h-[90vh] overflow-hidden" onclick="event.stopPropagation()">
        <div class="p-6 border-b flex justify-between items-center">
            <h3 class="text-xl font-bold">{% if lang == 'fr' %}S√©lectionner ou uploader une image{% else %}Select or Upload Image{% endif %}</h3>
            <button onclick="closeImagePicker()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
        </div>
        
        <div class="p-6 border-b bg-gray-50">
            <input type="file" id="quickUploadInput" accept="image/*" class="hidden" onchange="quickUploadImage()">
            <label for="quickUploadInput" class="cursor-pointer inline-block bg-accent text-white px-6 py-3 rounded-full hover:bg-primary transition-colors font-semibold">
                ‚¨ÜÔ∏è {% if lang == 'fr' %}Uploader une nouvelle image{% else %}Upload New Image{% endif %}
            </label>
            <div id="quickUploadProgress" class="hidden mt-4">
                <div class="bg-gray-200 rounded-full h-2">
                    <div id="quickUploadBar" class="bg-accent h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p class="text-sm text-gray-600 mt-2">{% if lang == 'fr' %}Upload en cours...{% else %}Uploading...{% endif %}</p>
            </div>
        </div>
        
        <div class="p-6 overflow-y-auto" style="max-height: 60vh;">
            {% if images %}
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {% for image in images %}
                <div class="group relative bg-gray-100 rounded overflow-hidden cursor-pointer hover:ring-4 hover:ring-accent transition-all"
                     onclick="selectImage('/static/uploads/{{ image.filename }}')">
                    <img src="/static/uploads/{{ image.filename }}" alt="{{ image.alt_text }}" 
                         class="w-full h-32 object-cover">
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all flex items-center justify-center">
                        <p class="text-white text-xs opacity-0 group-hover:opacity-100 transition-all px-2 text-center">
                            {{ image.width }}x{{ image.height }}px
                        </p>
                    </div>
                    <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-all">
                        <span class="bg-accent text-white px-2 py-1 rounded text-xs font-bold">‚úì</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 text-center py-12">{% if lang == 'fr' %}Aucune image disponible. Uploadez votre premi√®re image!{% else %}No images available. Upload your first image!{% endif %}</p>
            {% endif %}
        </div>
    </div>
</div>

<script>
let currentTargetInput = null;

function showAddSection() {
    document.getElementById('addSectionForm').classList.remove('hidden');
}

function hideAddSection() {
    document.getElementById('addSectionForm').classList.add('hidden');
}

function openImagePicker(inputId) {
    currentTargetInput = inputId;
    document.getElementById('imagePickerModal').classList.remove('hidden');
}

function closeImagePicker(event) {
    if (!event || event.target === event.currentTarget) {
        document.getElementById('imagePickerModal').classList.add('hidden');
        currentTargetInput = null;
    }
}

function selectImage(url) {
    if (currentTargetInput) {
        document.getElementById(currentTargetInput).value = url;
        closeImagePicker();
    }
}

function quickUploadImage() {
    const fileInput = document.getElementById('quickUploadInput');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    const progressDiv = document.getElementById('quickUploadProgress');
    const progressBar = document.getElementById('quickUploadBar');
    progressDiv.classList.remove('hidden');
    progressBar.style.width = '30%';
    
    fetch('/admin/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        progressBar.style.width = '100%';
        if (data.success) {
            if (currentTargetInput) {
                document.getElementById(currentTargetInput).value = data.image.url;
            }
            setTimeout(() => {
                location.reload();
            }, 500);
        } else {
            alert('{% if lang == "fr" %}Erreur{% else %}Error{% endif %}: ' + (data.error || 'Upload failed'));
            progressDiv.classList.add('hidden');
        }
    })
    .catch(error => {
        alert('{% if lang == "fr" %}Erreur d\'upload{% else %}Upload error{% endif %}: ' + error);
        progressDiv.classList.add('hidden');
    })
    .finally(() => {
        fileInput.value = '';
    });
}
</script>
{% endblock %}
