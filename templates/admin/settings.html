<!--
 * Nom de l'application : Bellari Concept
 * Description : Admin Settings Page
 * Produit de : MOA Digital Agency, www.myoneart.com
 * Fait par : Aisance KALONJI, www.aisancekalonji.com
 * Auditer par : La CyberConfiance, www.cyberconfiance.com
-->
{% extends "admin/base.html" %}

{% block title %}Site Settings - Admin{% endblock %}

{% block content %}
<div class="max-w-4xl">
    <h1 class="text-3xl font-bold mb-8">Site Settings</h1>

    <form method="POST" action="{{ url_for('admin_settings') }}" class="space-y-8">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <!-- Logo Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Site Logo</h2>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Current Logo</label>
                {% if settings.get('site_logo') %}
                    <div class="mb-4">
                        <img src="{{ settings.get('site_logo', '/static/logo.png') }}" alt="Site Logo" class="max-h-24">
                    </div>
                {% else %}
                    <div class="mb-4">
                        <img src="/static/logo.png" alt="Default Logo" class="max-h-24">
                        <p class="text-sm text-gray-500 mt-2">Using default logo</p>
                    </div>
                {% endif %}
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Upload New Logo</label>
                <input type="file" id="logo-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100">
                <p class="text-xs text-gray-500 mt-1">Recommended: PNG or SVG format, transparent background</p>
            </div>

            <div class="hidden mb-4" id="logo-preview-container">
                <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
                <img id="logo-preview" src="" alt="Logo Preview" class="max-h-24 border border-gray-300 rounded">
            </div>

            <button type="button" id="upload-logo-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-full disabled:opacity-50" disabled>Upload Logo</button>
            <input type="hidden" name="site_logo" id="site_logo" value="{{ settings.get('site_logo', '') }}">
        </div>

        <!-- Favicon Section -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Site Favicon</h2>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Current Favicon</label>
                {% if settings.get('site_favicon') %}
                    <div class="mb-4">
                        <img src="{{ settings.get('site_favicon', '/static/logo.png') }}" alt="Site Favicon" class="h-12 w-12 object-contain rounded border">
                    </div>
                {% else %}
                    <div class="mb-4">
                        <img src="/static/logo.png" alt="Default Favicon" class="h-12 w-12 object-contain rounded border">
                        <p class="text-sm text-gray-500 mt-2">Using default logo as favicon</p>
                    </div>
                {% endif %}
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Upload New Favicon</label>
                <input type="file" id="favicon-upload" accept="image/x-icon,image/png,image/gif" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100">
                <p class="text-xs text-gray-500 mt-1">Recommended: ICO or PNG format, 32x32 or 16x16 pixels</p>
            </div>

            <div class="hidden mb-4" id="favicon-preview-container">
                <label class="block text-sm font-medium text-gray-700 mb-2">Preview</label>
                <img id="favicon-preview" src="" alt="Favicon Preview" class="h-12 w-12 object-contain rounded border">
            </div>

            <button type="button" id="upload-favicon-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-full disabled:opacity-50" disabled>Upload Favicon</button>
            <input type="hidden" name="site_favicon" id="site_favicon" value="{{ settings.get('site_favicon', '') }}">
        </div>

        <!-- Site Names -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Site Names</h2>
            
            <div class="mb-4">
                <label for="site_name_fr" class="block text-sm font-medium text-gray-700 mb-2">Site Name (French)</label>
                <input type="text" id="site_name_fr" name="site_name_fr" value="{{ settings.get('site_name_fr', 'Bellari Concept') }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
            </div>

            <div class="mb-4">
                <label for="site_name_en" class="block text-sm font-medium text-gray-700 mb-2">Site Name (English)</label>
                <input type="text" id="site_name_en" name="site_name_en" value="{{ settings.get('site_name_en', 'Bellari Concept') }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
            </div>
        </div>

        <!-- SEO Settings -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">SEO Settings</h2>
            
            <div class="mb-4">
                <label for="default_meta_keywords" class="block text-sm font-medium text-gray-700 mb-2">Default Meta Keywords</label>
                <input type="text" id="default_meta_keywords" name="default_meta_keywords" value="{{ settings.get('default_meta_keywords', '') }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent" placeholder="interior design, luxury homes, architecture">
                <p class="text-xs text-gray-500 mt-1">Comma-separated keywords for search engines</p>
            </div>

            <div class="mb-4">
                <label for="default_og_image" class="block text-sm font-medium text-gray-700 mb-2">Default Open Graph Image URL</label>
                <div class="flex gap-2">
                    <input type="text" id="default_og_image" name="default_og_image" value="{{ settings.get('default_og_image', '') }}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent" placeholder="/static/og-image.jpg">
                    <button type="button" onclick="document.getElementById('og-image-picker').classList.toggle('hidden')" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-full">Browse</button>
                </div>
                <p class="text-xs text-gray-500 mt-1">Image shown when your site is shared on social media (1200x630px recommended)</p>
                
                <div id="og-image-picker" class="hidden mt-3 p-3 bg-gray-50 rounded-lg max-h-64 overflow-y-auto">
                    <p class="text-sm font-medium text-gray-700 mb-2">Select an image:</p>
                    <div class="grid grid-cols-4 gap-2">
                        {% for image in images %}
                        <div class="cursor-pointer border-2 border-transparent hover:border-yellow-500 rounded" onclick="document.getElementById('default_og_image').value='/static/uploads/{{ image.filename }}'; document.getElementById('og-image-picker').classList.add('hidden')">
                            <img src="/static/uploads/{{ image.filename }}" alt="{{ image.alt_text }}" class="w-full h-20 object-cover rounded">
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <label for="google_analytics_id" class="block text-sm font-medium text-gray-700 mb-2">Google Analytics ID</label>
                <input type="text" id="google_analytics_id" name="google_analytics_id" value="{{ settings.get('google_analytics_id', '') }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent" placeholder="G-XXXXXXXXXX">
                <p class="text-xs text-gray-500 mt-1">Your Google Analytics measurement ID</p>
            </div>
        </div>

        <!-- PWA Settings -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">PWA Settings</h2>

            <div class="mb-6 flex items-center">
                <input type="checkbox" id="pwa_enabled" name="pwa_enabled" class="w-5 h-5 text-yellow-600 rounded focus:ring-yellow-500 border-gray-300" {% if settings.get('pwa_enabled', 'false') == 'true' %}checked{% endif %}>
                <label for="pwa_enabled" class="ml-2 block text-sm font-medium text-gray-700">Enable PWA (Progressive Web App)</label>
            </div>

            <div id="pwa_options" class="{% if settings.get('pwa_enabled', 'false') != 'true' %}hidden{% endif %} space-y-4">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Display Mode</label>
                    <div class="flex gap-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="pwa_display_mode" value="default" class="form-radio text-yellow-600" {% if settings.get('pwa_display_mode', 'default') == 'default' %}checked{% endif %}>
                            <span class="ml-2">Default (Use Site Name & Logo)</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="pwa_display_mode" value="custom" class="form-radio text-yellow-600" {% if settings.get('pwa_display_mode') == 'custom' %}checked{% endif %}>
                            <span class="ml-2">Custom</span>
                        </label>
                    </div>
                </div>

                <div id="pwa_custom_fields" class="{% if settings.get('pwa_display_mode', 'default') != 'custom' %}hidden{% endif %} space-y-4 border-l-2 border-yellow-500 pl-4">
                    <div>
                        <label for="pwa_app_name" class="block text-sm font-medium text-gray-700 mb-2">App Name</label>
                        <input type="text" id="pwa_app_name" name="pwa_app_name" value="{{ settings.get('pwa_app_name', 'Bellari Concept') }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">App Icon</label>
                        {% if settings.get('pwa_icon_url') %}
                            <div class="mb-2">
                                <img src="{{ settings.get('pwa_icon_url') }}" alt="App Icon" class="h-16 w-16 object-contain rounded-lg border">
                            </div>
                        {% endif %}
                        <input type="file" id="pwa-icon-upload" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-50 file:text-yellow-700 hover:file:bg-yellow-100">
                        <input type="hidden" name="pwa_icon_url" id="pwa_icon_url" value="{{ settings.get('pwa_icon_url', '') }}">
                        <button type="button" id="upload-pwa-icon-btn" class="mt-2 bg-yellow-600 hover:bg-yellow-700 text-white px-3 py-1 text-sm rounded-full disabled:opacity-50" disabled>Upload Icon</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="pwa_theme_color" class="block text-sm font-medium text-gray-700 mb-2">Theme Color</label>
                        <input type="color" id="pwa_theme_color" name="pwa_theme_color" value="{{ settings.get('pwa_theme_color', '#ffffff') }}" class="w-full h-10 p-1 border border-gray-300 rounded-lg">
                    </div>
                    <div>
                        <label for="pwa_background_color" class="block text-sm font-medium text-gray-700 mb-2">Background Color</label>
                        <input type="color" id="pwa_background_color" name="pwa_background_color" value="{{ settings.get('pwa_background_color', '#ffffff') }}" class="w-full h-10 p-1 border border-gray-300 rounded-lg">
                    </div>
                </div>
            </div>
        </div>

        <!-- Social Media -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">Social Media Links</h2>
            
            <div class="mb-4">
                <label for="facebook_url" class="block text-sm font-medium text-gray-700 mb-2">Facebook URL</label>
                <input type="url" id="facebook_url" name="facebook_url" value="{{ settings.get('facebook_url', '') }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent" placeholder="https://facebook.com/yourpage">
            </div>

            <div class="mb-4">
                <label for="instagram_url" class="block text-sm font-medium text-gray-700 mb-2">Instagram URL</label>
                <input type="url" id="instagram_url" name="instagram_url" value="{{ settings.get('instagram_url', '') }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent" placeholder="https://instagram.com/yourprofile">
            </div>

            <div class="mb-4">
                <label for="linkedin_url" class="block text-sm font-medium text-gray-700 mb-2">LinkedIn URL</label>
                <input type="url" id="linkedin_url" name="linkedin_url" value="{{ settings.get('linkedin_url', '') }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-transparent" placeholder="https://linkedin.com/company/yourcompany">
            </div>
        </div>

        <div class="flex gap-4">
            <button type="submit" class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-3 rounded-full font-medium">Save Settings</button>
            <a href="{{ url_for('admin_dashboard') }}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-3 rounded-full font-medium inline-block">Cancel</a>
        </div>
    </form>
</div>

<script>
// PWA Logic
const pwaEnabledCheckbox = document.getElementById('pwa_enabled');
const pwaOptions = document.getElementById('pwa_options');
const pwaDisplayModeRadios = document.getElementsByName('pwa_display_mode');
const pwaCustomFields = document.getElementById('pwa_custom_fields');

pwaEnabledCheckbox.addEventListener('change', function() {
    if (this.checked) {
        pwaOptions.classList.remove('hidden');
    } else {
        pwaOptions.classList.add('hidden');
    }
});

pwaDisplayModeRadios.forEach(radio => {
    radio.addEventListener('change', function() {
        if (this.value === 'custom') {
            pwaCustomFields.classList.remove('hidden');
        } else {
            pwaCustomFields.classList.add('hidden');
        }
    });
});

// PWA Icon Upload
document.getElementById('pwa-icon-upload').addEventListener('change', function(e) {
    if (e.target.files.length > 0) {
        document.getElementById('upload-pwa-icon-btn').disabled = false;
    }
});

document.getElementById('upload-pwa-icon-btn').addEventListener('click', async function() {
    const fileInput = document.getElementById('pwa-icon-upload');
    const file = fileInput.files[0];

    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    this.disabled = true;
    this.textContent = 'Uploading...';

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch('{{ url_for("admin_upload_pwa_icon") }}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            document.getElementById('pwa_icon_url').value = data.icon_url;
            alert('Icon uploaded successfully! Click "Save Settings" to apply changes.');
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Upload failed: ' + error);
    } finally {
        this.disabled = false;
        this.textContent = 'Upload Icon';
    }
});

document.getElementById('logo-upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('logo-preview').src = e.target.result;
            document.getElementById('logo-preview-container').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
        document.getElementById('upload-logo-btn').disabled = false;
    }
});

document.getElementById('upload-logo-btn').addEventListener('click', async function() {
    const fileInput = document.getElementById('logo-upload');
    const file = fileInput.files[0];
    
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    this.disabled = true;
    this.textContent = 'Uploading...';
    
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch('{{ url_for("admin_upload_logo") }}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('site_logo').value = data.logo_url;
            alert('Logo uploaded successfully! Click "Save Settings" to apply changes.');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Upload failed: ' + error);
    } finally {
        this.disabled = false;
        this.textContent = 'Upload Logo';
    }
});

document.getElementById('favicon-upload').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('favicon-preview').src = e.target.result;
            document.getElementById('favicon-preview-container').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
        document.getElementById('upload-favicon-btn').disabled = false;
    }
});

document.getElementById('upload-favicon-btn').addEventListener('click', async function() {
    const fileInput = document.getElementById('favicon-upload');
    const file = fileInput.files[0];

    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    this.disabled = true;
    this.textContent = 'Uploading...';

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    try {
        const response = await fetch('{{ url_for("admin_upload_favicon") }}', {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
            body: formData
        });

        const data = await response.json();

        if (data.success) {
            document.getElementById('site_favicon').value = data.favicon_url;
            alert('Favicon uploaded successfully! Click "Save Settings" to apply changes.');
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Upload failed: ' + error);
    } finally {
        this.disabled = false;
        this.textContent = 'Upload Favicon';
    }
});
</script>
{% endblock %}
